# -*- coding: utf-8 -*-
"""Sumary_task_Python.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1WP2-ESBnYIOIcfAg2Fr1OB_a5kI8Vu4_
"""

# === –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ –æ–±–ª–∞—á–Ω–æ–π –ë–î ===
!pip install python-dotenv
from dotenv import load_dotenv
# === –Ø–≤–∫–∏-–ø–∞—Ä–æ–ª–∏ –æ—Ç –ë–î ===
from google.colab import files
uploaded = files.upload()

# === –ò–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π ====
import psycopg2, requests, json, logging, os, ast
from datetime import datetime, timedelta
from pathlib import Path
from psycopg2.extras import execute_values
import pandas as pd

# === –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ===

logs_dir = Path("logs")#—Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ logs –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ .log
logs_dir.mkdir(exist_ok=True)#—Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–∞–ø–∫–∞ logs (–µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ –µ—Å—Ç—å, —Ç–æ –∏–∑–±–µ–≥–∞—Ç—å –æ—à–∏–±–∫–∏)
now = datetime.now() #—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è

#—É–¥–∞–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ —Å—Ç–∞—Ä—à–µ —Ç—Ä–µ—Ö –¥–Ω–µ–π
for log_file in logs_dir.glob("*.log"):
    if (now - datetime.fromtimestamp(log_file.stat().st_mtime)).days > 3:
        log_file.unlink()

# –∏–º—è —Ç–µ–∫—É—â–µ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞ –ø–æ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–µ
log_filename = logs_dir / f"{now.strftime('%Y-%m-%d')}.log"

#–æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã
for handler in logging.root.handlers[:]:
    logging.root.removeHandler(handler)

#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    filename=log_filename,
    level=logging.INFO,
    format='%(asctime)s %(name)s %(levelname)s: %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logging.info(f"–ù–∞—á–∞–ª–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è {now}")


# === API ===

def fetch_data(start, end): #—Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ API
    api_url = "https://b2b.itresume.ru/api/statistics" #URL-–∞–¥—Ä–µ—Å
    #–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    data = {
        "client": "Skillfactory",
        "client_key": "M2MGWS",
        "start": start,
        "end": end
    }
    try:
        logging.info("–ù–∞—á–∞–ª–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å API.")
        response = requests.get(api_url, params=data)#–Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–ø—Ä–æ—Å API
        response.raise_for_status()#–µ—Å–ª–∏ HTTP-—Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ ‚Äî –Ω–µ 200, —Ç–æ except.
        logging.info("–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ.")
        return response.json()

    except requests.exceptions.HTTPError as e:
        logging.error(f"–û—à–∏–±–∫–∞ HTTP: {e} - –°—Ç–∞—Ç—É—Å: {response.status_code}")
        return []

    except requests.RequestException as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API: {e}")
        return []


# === –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö ===

def parse_passback_params(raw): #—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∑–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ passback_params –≤ —Å–ª–æ–≤–∞—Ä—å
    try:
        return ast.literal_eval(raw) #–ø–∞—Ä—Å–∏–Ω–≥ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º  –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ—Ä–µ–≤—å–µ–≤ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –≥—Ä–∞–º–º–∞—Ç–∏–∫
        #json.loads(raw.replace("'", "\"")) - –±–µ–∑ –¥–µ—Ä–µ–≤–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏—Ö –≥—Ä–∞–º–º–∞—Ç–∏–∫ —Ç–æ–∂–µ –º–æ–∂–Ω–æ
    except Exception as e:
        logging.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å passback_params: {raw} | –û—à–∏–±–∫–∞: {e}")
        return {}#–≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ - –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å


def process_data(response): #—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∏–∑ fetch_data(), —Ç.–µ. –∏–∑ API
    processed = []
    for r in response:
        passback = parse_passback_params(r.get("passback_params", "{}"))
        try:
            record = {
                "user_id": r["lti_user_id"],#—Å—Ç—Ä–æ–∫–æ–≤—ã–π id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                "oauth_consumer_key": passback.get("oauth_consumer_key", ""), #—É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –∫–ª–∏–µ–Ω—Ç–∞
                "lis_result_sourcedid": passback.get("lis_result_sourcedid", ""), # —Å—Å—ã–ª–∫–∞ –Ω–∞ –±–ª–æ–∫, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞–¥–∞—á–∞ –≤ –õ–ú–°
                "lis_outcome_service_url": passback.get("lis_outcome_service_url", ""),# URL –∞–¥—Ä–µ—Å –≤ –õ–ú–°, –∫—É–¥–∞ –º—ã —à–ª–µ–º –æ—Ü–µ–Ω–∫—É
                "is_correct": None if r['attempt_type'] == "run" else r['is_correct'], # –±—ã–ª–∞ –ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –≤–µ—Ä–Ω–æ–π (null, –µ—Å–ª–∏ —ç—Ç–æ run)
                "attempt_type": r["attempt_type"], # —Ä–∞–Ω(–∑–∞–ø—É—Å–∫ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏) –∏–ª–∏ —Å–∞–±–º–∏—Ç(–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É)
                "created_at": datetime.strptime(r['created_at'], '%Y-%m-%d %H:%M:%S.%f') # –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∏
            }

            if not record["user_id"] or not record["created_at"]: #–µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã–π id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç - –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥ –∏ –Ω–∏–∫–∞–∫–∏—Ö –≥–≤–æ–∑–¥–µ–π
                raise ValueError("–ü—Ä–æ–ø—É—â–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è")

            processed.append(record)
        except Exception as e:
            logging.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø–∏—Å–∏: {e} | –ó–∞–ø–∏—Å—å: {r}")
    return processed #—Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏, –≥–æ—Ç–æ–≤—ã–∏–º –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ë–î


# === –ó–∞–≥—Ä—É–∑–∫–∞ –≤ –æ–±–ª–∞—á–Ω—É—é –ë–î ===

def insert_to_db(processed): #—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ë–î

    if not processed:#–µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π - –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥ –∏ –≤—Å—ë
        logging.info("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–∑—É.")
        return

    try:
        #—è–≤–∫–∏-–ø–∞—Ä–æ–ª–∏
        load_dotenv(".env")
        HOST = os.getenv("HOST")
        PORT = os.getenv("PORT")
        DATABASE = os.getenv("DATABASE")
        USER = os.getenv("USER")
        PASSWORD = os.getenv("PASSWORD")

        conn = psycopg2.connect( # —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –ë–î
            dbname=DATABASE,
            user=USER,
            password=PASSWORD,
            host=HOST,
            port=PORT
        )

        cursor = conn.cursor() # —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫—É—Ä—Å–æ—Ä

        logging.info("–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑—É.")

        #SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ –ë–î
        insert_query = """
            INSERT INTO pars_db (
                user_id, oauth_consumer_key, lis_result_sourcedid,
                lis_outcome_service_url, is_correct, attempt_type, created_at
            ) VALUES %s
        """
        #–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏
        data_tuples = [
            (
                r["user_id"],
                r["oauth_consumer_key"],
                r["lis_result_sourcedid"],
                r["lis_outcome_service_url"],
                r["is_correct"],
                r["attempt_type"],
                r["created_at"]
            ) for r in processed
        ]

        execute_values(cursor, insert_query, data_tuples)#–¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
        conn.commit()#–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏–∏
        logging.info("–ó–∞–≥—Ä—É–∑–∫–∞ –≤ –±–∞–∑—É –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ.")
        cursor.close()#–∑–∞–∫—Ä—ã—Ç—å –∫—É—Ä—Å–æ—Ä
        conn.close()#–∑–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: {e}")


# === –ó–∞–ø—É—Å–∫ ===

end_time = datetime.utcnow() #–ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
start_time = end_time - timedelta(days=1) #–Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞ –∑–∞ —Å—É—Ç–∫–∏ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏

try:
    #raw —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ, –≤—ã–∫–∞—á–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–µ–π fetch_data()
    raw = fetch_data(
          start=start_time.strftime("%Y-%m-%d %H:%M:%S.%f"),
          end=end_time.strftime("%Y-%m-%d %H:%M:%S.%f")
                    )
    #data —Ö—Ä–∞–Ω–∏—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    data = process_data(raw)

    #–∑–∞–Ω–æ—Å–∏–º –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
    insert_to_db(data)
except Exception as e:
    logging.exception("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")

finally:
    with open(log_filename, "r", encoding='utf-8') as f:
        print(f.read())

# === –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –≤ –ë–î, —Å–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ DF ===
# —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –∏ DF
def get_df(start_time, end_time):
    try:
        #—è–≤–∫–∏-–ø–∞—Ä–æ–ª–∏
        load_dotenv(".env")
        HOST = os.getenv("HOST")
        PORT = os.getenv("PORT")
        DATABASE = os.getenv("DATABASE")
        USER = os.getenv("USER")
        PASSWORD = os.getenv("PASSWORD")

        conn = psycopg2.connect( # —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –ë–î
            dbname=DATABASE,
            user=USER,
            password=PASSWORD,
            host=HOST,
            port=PORT
        )

        cursor = conn.cursor() # —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫—É—Ä—Å–æ—Ä
        cursor.execute('SELECT * FROM pars_db WHERE (created_at >= %s and created_at <= %s)', (start_time, end_time,))
        res = cursor.fetchall()
        df = pd.DataFrame(res, columns=['user_id', 'oauth_consumer_key', 'lis_result_sourcedid', 'lis_outcome_service_url', 'is_correct', 'attempt_type', 'created_at'])

        #–ø–æ–¥—Å—á–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        total_rows = len(df) #—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ (run –∏ submit) –≤—Å–µ–≥–æ –±—ã–ª–æ —Å–æ–≤–µ—Ä—à–µ–Ω–æ –∑–∞ –¥–µ–Ω—å
        submit_count = len(df[df['attempt_type'] == 'submit'])#—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ (submit) –±—ã–ª–æ —Å–æ–≤–µ—Ä—à–µ–Ω–æ –∑–∞ –¥–µ–Ω—å
        is_correct_count = len(df[df['is_correct'] == '1'])#—Å–∫–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –±—ã–ª–æ –∏–∑ –≤—Å–µ—Ö —Å–æ–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞ –¥–µ–Ω—å
        user_id_count = len(df['user_id'].unique())#–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —é–∑–µ—Ä–æ–≤ –∑–∞ –¥–µ–Ω—å

        #–¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–µ–≥–æ —á–∏—Å–ª–∞ –ø–æ–ø—ã—Ç–æ–∫
        def attempts_until_correct(group):
            try:
                idx = group['is_correct'].idxmax()  # –ø–µ—Ä–≤–∞—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞
                return group.loc[:idx].shape[0]
            except:
                return None  # –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –Ω–µ—Ç
        df_sorted = df.sort_values(['user_id', 'created_at'])#—Å–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—Ä–µ–π–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –≤—Ä–µ–º–µ–Ω–∏
        attempts_to_success = df_sorted.groupby('user_id').apply(attempts_until_correct).dropna()
        avg_attempts_to_success = round(attempts_to_success.mean(), 2) if not attempts_to_success.empty else None

        # –∫–æ–ª-–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å 0 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö
        users_with_no_correct = df.groupby('user_id')['is_correct'].sum()
        users_with_zero_correct = (users_with_no_correct == 0).sum()

        cursor.close()#–∑–∞–∫—Ä—ã—Ç—å –∫—É—Ä—Å–æ—Ä
        conn.close()#–∑–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    except Exception as e:
        print("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î")
    return total_rows, submit_count, is_correct_count, round(is_correct_count/submit_count, 2), user_id_count, round(total_rows/user_id_count, 2),avg_attempts_to_success, users_with_zero_correct

# === –¢–∞–±–ª–∏—Ü–∞ –≤ GoogleSheets –≤–∞—Ä–∏–∞–Ω—Ç 1 –¥–ª—è GoogleColab===

#–¥–æ—Å—Ç—É–ø –∫ –∞–∫–∫–∞—É–Ω—Ç—É
from google.colab import auth
auth.authenticate_user()

#–∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π
import gspread
from google.auth import default

#–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets
creds, _ = default()
gc = gspread.authorize(creds)

#
import pandas as pd
from gspread_dataframe import set_with_dataframe

# –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
today = start_time.strftime('%Y-%m-%d')
df = pd.DataFrame({
    '–î–∞—Ç–∞': today,
    '–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å': ['–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏', '–ü—Ä–æ–≤–µ—Ä–∫–∏', '–í–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã', '–î–æ–ª—è –≤–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, %', '–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', '–°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', '–°—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞', '–ö–æ–ª-–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å 0 –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö'],
    '–ö–æ–ª-–≤–æ': get_df(start_time, end_time),
    '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ':['–í—Å–µ–≥–æ –∑–∞ –¥–µ–Ω—å –ø–æ–ø—ã—Ç–æ–∫ —Ä–µ—à–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–¥–∞—á–∏','–í—Å–µ–≥–æ –∑–∞ –¥–µ–Ω—å –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–¥–∞—á–∏','–£—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–¥–∞—á–∏','–î–æ–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–∞–¥–∞—á –≤ –æ–±—â–µ–º —á–∏—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∑–∞ –¥–µ–Ω—å', '–í—Å–µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –¥–µ–Ω—å','–ù–∞—Å–∫–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω–æ —É—á–∏–ª–∏—Å—å (–≤ —Å—Ä–µ–¥–Ω–µ–º –ø–æ –∫–∞–∂–¥–æ–º—É)','–ù–∞—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä–æ –ª—é–¥–∏ –Ω–∞—Ö–æ–¥—è—Ç –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç','–ö—Ç–æ —Å–æ–≤—Å–µ–º –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è']
    })




# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Google Sheet
sheet_id = "14NOMnloo2KETuRHkjm0Vj-JtEg0i-Ve0yAHgVur2NjI"  # ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π –≤ —Ä—É—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—ã
sh = gc.open_by_key(sheet_id)

# –í—ã–±–∏—Ä–∞–µ–º –ª–∏—Å—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –ø–µ—Ä–≤—ã–π)
worksheet = sh.sheet1

# –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É
set_with_dataframe(worksheet, df)

# –û—Ç–∫—Ä–æ–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ/—á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å Google –¢–∞–±–ª–∏—Ü—É"
#import webbrowser
#print(f"üîó –í–æ—Ç —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É:\nhttps://docs.google.com/spreadsheets/d/{sheet_id}/edit")

from IPython.display import HTML
sheet_url = f"https://docs.google.com/spreadsheets/d/{sheet_id}/edit"
HTML(f'<a href="{sheet_url}" target="_blank"><button>–û—Ç–∫—Ä—ã—Ç—å Google –¢–∞–±–ª–∏—Ü—É</button></a>')

# === –ó–∞–¥–∞–Ω–∏–µ —Å –¥–≤—É–º—è –∑–≤–µ–∑–¥–æ—á–∫–∞–º–∏: –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –Ω–∞ –ø–æ—á—Ç—É ===

#–∏–º–ø–æ—Ä—Ç –º–æ–¥—É–ª–µ–π
import smtplib
import ssl
from email.message import EmailMessage

#—Ñ–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞
def send_email_notification(subject, body):
    try:
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        smtp_server = "smtp.mail.ru"
        port = 465  # SSL –ø–æ—Ä—Ç
        sender_email = "therestwetest@mail.ru"
        receiver_email = "marfa_ii@mail.ru"
        password = "EsfsENn017ramemS7RW8"  # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        msg = EmailMessage()
        msg.set_content(body)
        msg["Subject"] = subject
        msg["From"] = sender_email
        msg["To"] = receiver_email

      # HTML-–≤–µ—Ä—Å–∏—è —Å —Ç–∞–±–ª–∏—Ü–µ–π
        html_content = f"""
        <html>
            <body>
                <p>–î–æ–±—Ä—ã–π –¥–µ–Ω—å!<br><br>
                –û—Ç—á–µ—Ç –∑–∞ <b>{today}</b> —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Google –¢–∞–±–ª–∏—Ü—É.<br>
                –ù–∏–∂–µ ‚Äî –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞:</p>
                {html_table}
                <p>–•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!<br> </p>
            </body>
        </html>
        """
        msg.add_alternative(html_content, subtype="html")



      # –ó–∞—â–∏—â—ë–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        context = ssl.create_default_context()
        with smtplib.SMTP_SSL(smtp_server, port, context=context) as server:
            server.login(sender_email, password)
            server.send_message(msg)

        logging.info("–ü–∏—Å—å–º–æ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email: {e}")


# === Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google Sheets ===
# –°–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º df –≤ HTML-—Ç–∞–±–ª–∏—Ü—É —Å –∫—Ä–∞—Å–∏–≤—ã–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
html_table = df.to_html(index=False, border=1, justify="center")

subject = f"–û—Ç—á–µ—Ç –∑–∞ {today} —É—Å–ø–µ—à–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω"
send_email_notification(subject, html_table)